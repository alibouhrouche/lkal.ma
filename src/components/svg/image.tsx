import {Editor, FileHelpers, SvgExportContext} from "tldraw";
import { ComponentShape } from "@/components/tools";
import SVGContainer from "@/components/svg/container.tsx";

const imageSVGHeaderPath =
  "M1.9 15.9q-.8 0-1.2-.3-.4-.4-.4-.9.1-.3.3-.5.2-.2.6-.3.8-.1 1.4-.2h1.2q-.2-.4-.1-.8 0-1.3.2-2.4.1-1.2.2-2.1v-.3q-.7 0-1.2.1t-1 .1q-.7 0-.9-.3-.3-.4-.3-.8.1-.4.3-.6.3-.3.9-.4.9-.1 2-.2T6 5.8h1.9q.9 0 1.2.2.3.2.2.7 0 .6-.5.9-.5.4-1.2.4H6.1q.1.3.1.7 0 .6-.2 1.8-.1 1.2-.2 2.7 0 .3-.1.4.4.1.9.1h1q1 0 1.2.2.3.3.3.7 0 .5-.5.8-.4.3-1.2.3-1.9 0-3.3.1t-2.2.1Zm9.9 0q-.5 0-.8-.3-.3-.3-.4-.8-.1-.5-.1-1.1.1-.7.2-1.3.1-.6.1-1.4.1-.3 0-.6v-.7q0-.2.2-.4t.6-.2q.4 0 .7.2.3.3.4.7.4-.7.9-1 .6-.4 1.2-.4.9 0 1.3.7t.6 1.8q.1.3.1.5.1.2.1.4.7-1.5 1.6-2.4 1-.9 2-.9t1.6.8q.5.8.6 2.5.1.9.2 1.4.1.5.2.8.1.3.2.5t.1.4q0 .4-.3.6-.3.2-.7.2-.7 0-1.1-.6-.5-.5-.6-1.9-.1-.8-.2-1.3t-.1-.8q-.1-.3-.2-.5-.8.7-1.3 1.8-.5 1-1 2.5-.2.4-.4.6-.3.2-.7.2-.8 0-1.2-.7-.3-.6-.5-1.7t-.3-1.6q-.1-.6-.4-1-.7.8-1.1 1.9-.3 1.1-.6 2.3-.1.8-.9.8Zm15.7 0q-1.2 0-1.9-.7t-.6-1.7q0-.9.4-1.8.5-.8 1.2-1.6.7-.7 1.6-1.1.9-.4 1.8-.4 1 0 1.1.7h.3q.5 0 .9.3t.5.8q.2.9.3 1.7.2.7.5 1.4t.9 1.4q.2.3.2.8-.1.4-.4.8-.3.3-.8.3-.3 0-.4-.1-.2-.1-.3-.3-.5-.7-.9-1.4t-.6-1.8q-.5 1-1.1 1.6-.7.6-1.4.8-.7.3-1.3.3Zm-.5-2.2v.1h.6q.8 0 1.6-.8.7-.9 1.1-2.6-.9.2-1.7.7-.7.5-1.1 1.2-.4.7-.5 1.4Zm14.2 6.8q-1.4 0-2.3-.3-.8-.2-1.3-.6-.5-.4-.7-.9-.1-.5-.1-.9 0-.5.3-.9.4-.3.9-.3.4 0 .5.1.1.2.1.4 0 .6.6.9.6.4 2 .4.9 0 1.3-.4t.4-1.2q.1-1.2-.1-2-.1-.8-.3-1.8-.6 1-1.5 1.3-.9.4-1.8.4-1.6 0-2.5-.8-.9-.8-.9-2.3.1-.9.5-1.6.4-.8 1-1.4.7-.5 1.5-.8.8-.4 1.7-.4.8 0 1.3.3t.7.7q.2-.2.7-.2.6 0 .9.4.3.4.3.9 0 1.1.1 1.9.2.8.3 1.6.2.9.2 1.8.1.9.1 2.2-.1 1.6-1.1 2.6-1 .9-2.8.9Zm-3.3-8.9q0 .5.3.8.3.2 1.1.2 1 0 1.8-.6.7-.5 1-1.8-.2 0-.3-.1-.2-.1-.3-.3-.1-.1-.3-.2-.2-.1-.5-.1-.7 0-1.3.3-.6.3-1 .8t-.5 1ZM50.5 17q-1.5 0-2.3-.5-.9-.5-1.3-1.5-.4-.9-.4-2.1.1-.9.5-1.9.3-.9 1-1.7.7-.8 1.6-1.3.8-.4 1.9-.4 1.5 0 2.3.7.8.8.8 2.2-.1 1-.7 1.7t-1.6 1q-.9.3-2 .3-.6 0-1-.1t-.7-.3q0 .9.4 1.4.3.6 1.4.6.9 0 1.6-.2.7-.2 1.1-.5.4-.3.8-.5.3-.2.6-.2.6 0 .6.8-.1.6-.7 1.2t-1.6.9q-1 .4-2.3.4Zm1-7.4q-.9 0-1.6.7-.7.6-1 1.6.2 0 .5.1h.7q1 0 1.7-.4.6-.4.7-1 0-1-1-1Z";

async function getDataURIFromURL(url: string): Promise<string> {
  const response = await fetch(url);
  const blob = await response.blob();
  return FileHelpers.blobToDataUrl(blob);
}

export default async function imageSVG({
  editor,
  shape,
  ctx,
}: {
  editor: Editor;
  shape: ComponentShape;
  ctx: SvgExportContext;
}) {
  const image = shape.props.data.find((d) => d.type === "image");
  const data_url = image
    ? await getDataURIFromURL(image.src)
    : await import("./placeholder.ts").then(m => m.default);
  return (
    <SVGContainer
      editor={editor}
      shape={shape}
      ctx={ctx}
      headerPath={imageSVGHeaderPath}
    >
      <image
        x="0"
        y="32"
        width={shape.props.w}
        height={shape.props.h - 32}
        preserveAspectRatio="xMidYMid slice"
        href={data_url}
      />
      <path
        fill="#fff"
        fillRule="evenodd"
        d="M14.8182 21.7579 2.00488 29.3144c-1.9875039 1.1722-1.959754 4.0566.04996 5.1902L14.856 41.7259c.7398.4173 1.6347.5191 2.4041.1589 8.3475-3.9082 8.3486-16.2377.0466-20.2967-.7937-.388-1.7276-.279-2.4885.1698Zm1.61 1.627c-.0796-.0389-.2976-.0791-.5941.0957L3.02087 31.0371c-.6608.3898-.65151 1.3487.01658 1.7255l12.80115 7.2213c.2881.1625.4966.1255.5734.0896 6.7869-3.1775 6.8475-13.3487.0162-16.6886ZM30.086 7.98151 17.275.426192c-.7607-.4485936-1.6942-.557625-2.4878-.17025C6.47252 4.31532 6.44074 16.6577 14.7782 20.5553c.7684.3591 1.6619.257 2.4009-.1593 2.8838-1.6247 5.7775-3.2503 8.6712-4.8757 1.3947-.7835 2.7895-1.567 4.183-2.3503 2.012-1.131 2.0408-4.01606.0527-5.18849ZM16.259 2.14894 29.07 9.70423c.6615.39007.6501 1.34747-.0167 1.72237-1.3925.7827-2.7867 1.5659-4.1812 2.3492-2.8943 1.6258-5.7899 3.2524-8.6747 4.8777-.2884.1625-.4965.1254-.5723.0899-6.7602-3.1602-6.81829-13.34209.0396-16.69021.08-.03906.2981-.0789.5943.09575Z"
        clipRule="evenodd"
        style={{ mixBlendMode: "difference" }}
        transform={`translate(${shape.props.w - 52}, ${shape.props.h - 60})`}
      ></path>
    </SVGContainer>
  );
}
